<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ramadan 2026</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2239605898396507"
     crossorigin="anonymous"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    text-align: center;
    background:#0f172a;
    color:white;
}

h1 { margin-bottom:5px; }
#locationName { font-size:14px; color:#94a3b8; margin-bottom:5px; }
#ramadanDay { font-size:18px; color:#fbbf24; margin-top:4px; font-weight:bold; }

.main-layout {
    display:flex;
    justify-content:center;
    align-items:flex-start;
    gap:20px;
    max-width:900px;
    margin:10px auto;
}

.main-center { flex:1; min-width:0; }

.time-boxes { max-width:320px; margin:10px auto; }

.time-box {
    background:#1e293b;
    padding:25px;
    border-radius:12px;
    margin:10px auto;
}

.time-box .time { font-size:34px; font-weight:bold; }
.time-box .countdown { font-size:16px; margin-top:8px; color:#facc15; font-weight:bold; }
.time-box.next-event { background:#16a34a; }

.namaz-panel {
    background:#1e293b;
    border-radius:12px;
    padding:18px 16px;
    min-width:180px;
    max-width:220px;
    text-align:left;
}

.namaz-panel h3 {
    margin:0 0 12px 0;
    text-align:center;
    font-size:16px;
    color:#facc15;
}

.namaz-table {
    width:100%;
    border-collapse:collapse;
    display:table;
}

.namaz-table td {
    padding:8px 6px;
    border-bottom:1px solid #334155;
    font-size:14px;
}

.namaz-table tr:last-child td {
    border-bottom:none;
}

.namaz-table td:first-child {
    color:#94a3b8;
    font-weight:bold;
}

.namaz-table td:last-child {
    text-align:right;
    font-weight:bold;
    color:#fff;
}

.namaz-table tr.active-namaz td {
    color:#16a34a;
}

.timetable-panel {
    background:#1e293b;
    border-radius:12px;
    padding:18px 16px;
    min-width:180px;
    max-width:220px;
    text-align:left;
}

.timetable-panel h3 {
    margin:0 0 12px 0;
    text-align:center;
    font-size:16px;
    color:#facc15;
}

.timetable-scroll {
    max-height:340px;
    overflow-y:auto;
}

.timetable-scroll::-webkit-scrollbar {
    width:4px;
}

.timetable-scroll::-webkit-scrollbar-track {
    background:#0f172a;
    border-radius:4px;
}

.timetable-scroll::-webkit-scrollbar-thumb {
    background:#475569;
    border-radius:4px;
}

.timetable-scroll::-webkit-scrollbar-thumb:hover {
    background:#64748b;
}

.timetable-table {
    width:100%;
    border-collapse:collapse;
    display:table;
}

.timetable-table th {
    padding:6px 4px;
    font-size:11px;
    color:#64748b;
    text-align:left;
    border-bottom:1px solid #334155;
}

.timetable-table th:last-child,
.timetable-table th:nth-child(2) {
    text-align:right;
}

.timetable-table td {
    padding:8px 4px;
    border-bottom:1px solid #334155;
    font-size:13px;
}

.timetable-table tr:last-child td {
    border-bottom:none;
}

.timetable-table td:first-child {
    color:#94a3b8;
    font-weight:bold;
}

.timetable-table td:nth-child(2),
.timetable-table td:last-child {
    text-align:right;
    font-weight:bold;
    color:#fff;
}

.timetable-table tr.highlight td {
    color:#16a34a;
}

.scroll-hint {
    text-align:center;
    font-size:11px;
    color:#64748b;
    margin-top:8px;
}

button {
    padding:10px 18px;
    border:none;
    border-radius:8px;
    background:#334155;
    color:white;
    cursor:pointer;
}

#loading { font-size:16px; color:#facc15; margin:30px 0; }

#refreshLocation, #enterLocationBtn {
    background:none;
    border:none;
    color:#94a3b8;
    font-size:12px;
    cursor:pointer;
    padding:2px 6px;
    text-decoration:underline;
}
#refreshLocation:hover, #enterLocationBtn:hover { color:#facc15; }

#locationControls {
    margin:8px auto;
    max-width:360px;
}

#manualLocationForm {
    display:none;
    margin:8px auto;
    max-width:360px;
}

#manualLocationForm .search-row {
    display:flex;
    gap:6px;
}

#manualLocationForm input[type="text"] {
    flex:1;
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #334155;
    background:#1e293b;
    color:white;
    font-size:14px;
    outline:none;
}

#manualLocationForm input[type="text"]:focus {
    border-color:#facc15;
}

#manualLocationForm button {
    padding:8px 14px;
    font-size:13px;
    white-space:nowrap;
}

#locationError {
    color:#f87171;
    font-size:12px;
    margin-top:6px;
    display:none;
}

#locationResults {
    list-style:none;
    padding:0;
    margin:6px 0 0 0;
    text-align:left;
}

#locationResults li {
    padding:8px 12px;
    background:#1e293b;
    border:1px solid #334155;
    border-radius:6px;
    margin-bottom:4px;
    cursor:pointer;
    font-size:13px;
    color:#e2e8f0;
}

#locationResults li:hover {
    background:#334155;
    border-color:#facc15;
}


@media (max-width: 600px) {
    .main-layout {
        flex-direction:column;
        align-items:center;
    }
    .main-center {
        order:-1;
    }
    .namaz-panel,
    .timetable-panel {
        max-width:320px;
        width:100%;
    }
}
</style>
</head>
<body>

<h1 id="heading">üåô Ramadan 2026</h1>
<div id="locationName"></div>
<div id="locationControls" style="display:none">
 <button id="refreshLocation" onclick="refreshLocation()">Update location</button>
 <span style="color:#475569;margin:0 4px;">|</span>
 <button id="enterLocationBtn" onclick="toggleManualEntry()">Enter city manually</button>
</div>
<div id="manualLocationForm">
 <div class="search-row">
  <input type="text" id="cityInput" placeholder="e.g. London, Karachi, New York" autocomplete="off">
  <button onclick="searchCity()">Search</button>
 </div>
 <div id="locationError"></div>
 <ul id="locationResults"></ul>
</div>
<div id="currentDate"></div>
<div id="ramadanDay"></div>

<div id="loading">Detecting your location...</div>

<div class="main-layout">
 <div class="timetable-panel" id="timetablePanel" style="display:none">
  <h3>üìÖ Ramadan Timetable</h3>
  <div class="timetable-scroll" id="timetableScroll">
   <table class="timetable-table" id="timetableTable">
    <thead>
     <tr><th>Day</th><th>Sehri</th><th>Aftar</th></tr>
    </thead>
    <tbody></tbody>
   </table>
  </div>
  <div class="scroll-hint" id="scrollHint">‚Üï Scroll for more</div>
 </div>
 <div class="main-center">
  <div class="time-boxes" id="timeBoxes"></div>
 </div>
 <div class="namaz-panel" id="namazPanel" style="display:none">
  <h3>üïå Local Prayer Times</h3>
  <div id="methodLabel" style="text-align:center;font-size:11px;color:#64748b;margin:-8px 0 10px 0;"></div>
  <table class="namaz-table" id="namazTable">
   <tbody></tbody>
  </table>
 </div>
</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

const fallbackData = [
{day:1,date:"2026-02-18",sehri:"05:29",aftar:"17:26"},
{day:2,date:"2026-02-19",sehri:"05:27",aftar:"17:28"},
{day:3,date:"2026-02-20",sehri:"05:25",aftar:"17:30"},
{day:4,date:"2026-02-21",sehri:"05:23",aftar:"17:31"},
{day:5,date:"2026-02-22",sehri:"05:21",aftar:"17:33"},
{day:6,date:"2026-02-23",sehri:"05:19",aftar:"17:35"},
{day:7,date:"2026-02-24",sehri:"05:17",aftar:"17:37"},
{day:8,date:"2026-02-25",sehri:"05:14",aftar:"17:39"},
{day:9,date:"2026-02-26",sehri:"05:12",aftar:"17:40"},
{day:10,date:"2026-02-27",sehri:"05:10",aftar:"17:42"},
{day:11,date:"2026-02-28",sehri:"05:08",aftar:"17:44"},
{day:12,date:"2026-03-01",sehri:"05:06",aftar:"17:46"},
{day:13,date:"2026-03-02",sehri:"05:04",aftar:"17:47"},
{day:14,date:"2026-03-03",sehri:"05:02",aftar:"17:49"},
{day:15,date:"2026-03-04",sehri:"04:59",aftar:"17:51"},
{day:16,date:"2026-03-05",sehri:"04:57",aftar:"17:53"},
{day:17,date:"2026-03-06",sehri:"04:55",aftar:"17:54"},
{day:18,date:"2026-03-07",sehri:"04:53",aftar:"17:56"},
{day:19,date:"2026-03-08",sehri:"04:51",aftar:"17:58"},
{day:20,date:"2026-03-09",sehri:"04:48",aftar:"18:00"},
{day:21,date:"2026-03-10",sehri:"04:46",aftar:"18:01"},
{day:22,date:"2026-03-11",sehri:"04:44",aftar:"18:03"},
{day:23,date:"2026-03-12",sehri:"04:42",aftar:"18:05"},
{day:24,date:"2026-03-13",sehri:"04:39",aftar:"18:06"},
{day:25,date:"2026-03-14",sehri:"04:37",aftar:"18:08"},
{day:26,date:"2026-03-15",sehri:"04:35",aftar:"18:10"},
{day:27,date:"2026-03-16",sehri:"04:33",aftar:"18:12"},
{day:28,date:"2026-03-17",sehri:"04:30",aftar:"18:13"},
{day:29,date:"2026-03-18",sehri:"04:28",aftar:"18:14"},
{day:30,date:"2026-03-19",sehri:"04:26",aftar:"18:15"},
];

const RAMADAN_DATES = [];
(function() {
 const start = new Date(2026, 1, 18);
 for (let i = 0; i < 30; i++) {
  const d = new Date(start);
  d.setDate(d.getDate() + i);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  RAMADAN_DATES.push({ day: i + 1, date: y + "-" + m + "-" + day });
 }
})();

let ramadanData = [];
let todayTimings = null;

const fallbackTimings = {
 Fajr: "05:19", Sunrise: "06:52", Dhuhr: "12:18", Asr: "15:02", Maghrib: "17:35", Isha: "19:10"
};

// Map country codes to Aladhan API calculation methods matching local mosque timetables
var METHOD_MAP = {
 "GB": 15, // UK - Moonsighting Committee Worldwide (used by most UK mosques)
 "PK": 1,  // Pakistan - University of Islamic Sciences, Karachi
 "IN": 1,  // India - Karachi method (widely used)
 "BD": 1,  // Bangladesh - Karachi method
 "SA": 4,  // Saudi Arabia - Umm Al-Qura University, Makkah
 "AE": 4,  // UAE - Umm Al-Qura
 "QA": 10, // Qatar
 "KW": 9,  // Kuwait
 "BH": 8,  // Bahrain - Gulf Region
 "OM": 8,  // Oman - Gulf Region
 "EG": 5,  // Egypt - Egyptian General Authority of Survey
 "TR": 13, // Turkey - Diyanet
 "FR": 12, // France - UOIF
 "SG": 11, // Singapore - MUIS
 "MY": 3,  // Malaysia - Muslim World League
 "ID": 20, // Indonesia - KEMKES
 "IR": 7,  // Iran - University of Tehran
 "RU": 14, // Russia - Spiritual Administration of Muslims
 "US": 2,  // USA - ISNA
 "CA": 2,  // Canada - ISNA
 "IQ": 3,  // Iraq - MWL
 "SY": 3,  // Syria - MWL
 "JO": 3,  // Jordan - MWL
 "LB": 3,  // Lebanon - MWL
 "PS": 3,  // Palestine - MWL
 "LY": 5,  // Libya - Egyptian
 "TN": 12, // Tunisia - UOIF
 "DZ": 12, // Algeria - UOIF
 "MA": 3,  // Morocco - MWL
 "AF": 1,  // Afghanistan - Karachi
 "SO": 3,  // Somalia - MWL
 "NG": 3,  // Nigeria - MWL
 "ZA": 3,  // South Africa - MWL
 "DE": 3,  // Germany - MWL
 "NL": 3,  // Netherlands - MWL
 "BE": 12, // Belgium - UOIF
 "IE": 15, // Ireland - Moonsighting Committee
 "AU": 3,  // Australia - MWL
 "NZ": 3   // New Zealand - MWL
};

var METHOD_NAMES = {
 1: "Karachi",
 2: "ISNA",
 3: "Muslim World League",
 4: "Umm Al-Qura",
 5: "Egyptian Authority",
 7: "Tehran",
 8: "Gulf Region",
 9: "Kuwait",
 10: "Qatar",
 11: "Singapore (MUIS)",
 12: "France (UOIF)",
 13: "Diyanet (Turkey)",
 14: "Russia",
 15: "Moonsighting Committee",
 20: "KEMKES (Indonesia)"
};

function getMethodForCountry(countryCode) {
 return METHOD_MAP[countryCode] || 3; // Default: Muslim World League
}

var detectedCountry = null;
var activeMethod = 3;

async function fetchLocationInfo(lat, lng) {
 try {
  const resp = await fetch("https://nominatim.openstreetmap.org/reverse?lat=" + lat + "&lon=" + lng + "&format=json");
  const data = await resp.json();
  const addr = data.address || {};
  var city = addr.city || addr.town || addr.village || addr.suburb || addr.county || "Your Location";
  var countryCode = (addr.country_code || "").toUpperCase();
  return { city: city, countryCode: countryCode };
 } catch (e) {
  return { city: "Your Location", countryCode: "" };
 }
}

async function fetchPrayerTimes(lat, lng, method) {
 var m = method || 3;
 const [febResp, marResp] = await Promise.all([
  fetch("https://api.aladhan.com/v1/calendar/2026/2?latitude=" + lat + "&longitude=" + lng + "&method=" + m),
  fetch("https://api.aladhan.com/v1/calendar/2026/3?latitude=" + lat + "&longitude=" + lng + "&method=" + m)
 ]);

 const febJson = await febResp.json();
 const marJson = await marResp.json();
 const allDays = [].concat(febJson.data, marJson.data);

 // Extract today's full namaz timings
 const todayStr = new Date().toISOString().split("T")[0];
 const todayApiDay = allDays.find(function(d) {
  var parts = d.date.gregorian.date.split("-");
  var formatted = parts[2] + "-" + parts[1] + "-" + parts[0];
  return formatted === todayStr;
 });
 if (todayApiDay) {
  var t = todayApiDay.timings;
  todayTimings = {
   Fajr: t.Fajr.split(" ")[0],
   Sunrise: t.Sunrise.split(" ")[0],
   Dhuhr: t.Dhuhr.split(" ")[0],
   Asr: t.Asr.split(" ")[0],
   Maghrib: t.Maghrib.split(" ")[0],
   Isha: t.Isha.split(" ")[0]
  };
 }

 const result = [];
 RAMADAN_DATES.forEach(function(rd) {
  const apiDay = allDays.find(function(d) {
   var parts = d.date.gregorian.date.split("-");
   var formatted = parts[2] + "-" + parts[1] + "-" + parts[0];
   return formatted === rd.date;
  });

  if (apiDay) {
   var fajr = apiDay.timings.Fajr.split(" ")[0];
   var maghrib = apiDay.timings.Maghrib.split(" ")[0];
   result.push({
    day: rd.day,
    date: rd.date,
    sehri: fajr,
    aftar: maghrib
   });
  }
 });

 return result;
}

function renderNamazTimes() {
 var timings = todayTimings || fallbackTimings;
 var namazList = [
  { name: "Fajr", time: timings.Fajr },
  { name: "Sunrise", time: timings.Sunrise },
  { name: "Dhuhr", time: timings.Dhuhr },
  { name: "Asr", time: timings.Asr },
  { name: "Maghrib", time: timings.Maghrib },
  { name: "Isha", time: timings.Isha }
 ];

 // Determine which namaz is currently active
 var now = new Date();
 var currentMinutes = now.getHours() * 60 + now.getMinutes();
 var activeIndex = -1;
 for (var i = namazList.length - 1; i >= 0; i--) {
  var parts = namazList[i].time.split(":").map(Number);
  var namazMinutes = parts[0] * 60 + parts[1];
  if (currentMinutes >= namazMinutes) {
   activeIndex = i;
   break;
  }
 }

 var tbody = document.querySelector("#namazTable tbody");
 tbody.innerHTML = "";
 namazList.forEach(function(item, idx) {
  var tr = document.createElement("tr");
  if (idx === activeIndex) tr.classList.add("active-namaz");
  tr.innerHTML = "<td>" + item.name + "</td><td>" + item.time + "</td>";
  tbody.appendChild(tr);
 });

 document.getElementById("namazPanel").style.display = "";
 var methodName = METHOD_NAMES[activeMethod] || "Method " + activeMethod;
 document.getElementById("methodLabel").textContent = "Based on " + methodName;
}

function getCachedLocation() {
 try {
  var cached = localStorage.getItem("ramadan2026_location");
  if (!cached) return null;
  var data = JSON.parse(cached);
  // Cache is valid for 24 hours
  if (Date.now() - data.timestamp > 24 * 60 * 60 * 1000) return null;
  return data;
 } catch (e) { return null; }
}

function setCachedLocation(lat, lng, city, countryCode) {
 try {
  localStorage.setItem("ramadan2026_location", JSON.stringify({
   lat: lat, lng: lng, city: city, countryCode: countryCode, timestamp: Date.now()
  }));
 } catch (e) {}
}

function getCachedPrayerTimes() {
 try {
  var cached = localStorage.getItem("ramadan2026_prayers");
  if (!cached) return null;
  var data = JSON.parse(cached);
  // Cache is valid for 12 hours
  if (Date.now() - data.timestamp > 12 * 60 * 60 * 1000) return null;
  return data;
 } catch (e) { return null; }
}

function setCachedPrayerTimes(prayerTimes, timings) {
 try {
  localStorage.setItem("ramadan2026_prayers", JSON.stringify({
   ramadanData: prayerTimes, todayTimings: timings, timestamp: Date.now()
  }));
 } catch (e) {}
}

function clearCache() {
 try {
  localStorage.removeItem("ramadan2026_location");
  localStorage.removeItem("ramadan2026_prayers");
 } catch (e) {}
}

async function refreshLocation() {
 clearCache();
 document.getElementById("loading").style.display = "";
 document.getElementById("loading").textContent = "Re-detecting your location...";
 await initApp(true);
}


async function initApp(forceRefresh) {
 var loadingEl = document.getElementById("loading");

 try {
  var lat, lng, cityName;

  // Try to use cached location first (unless force refresh)
  var cachedLoc = !forceRefresh ? getCachedLocation() : null;

  if (cachedLoc) {
   lat = cachedLoc.lat;
   lng = cachedLoc.lng;
   cityName = cachedLoc.city;
   detectedCountry = cachedLoc.countryCode;
   activeMethod = getMethodForCountry(detectedCountry);
  } else {
   if (!navigator.geolocation) throw new Error("Geolocation not supported");

   var position = await new Promise(function(resolve, reject) {
    navigator.geolocation.getCurrentPosition(resolve, reject, {
     timeout: 15000,
     enableHighAccuracy: true,
     maximumAge: 600000
    });
   });

   lat = position.coords.latitude;
   lng = position.coords.longitude;

   loadingEl.textContent = "Detecting location...";

   var locationInfo = await fetchLocationInfo(lat, lng);
   cityName = locationInfo.city;
   detectedCountry = locationInfo.countryCode;
   activeMethod = getMethodForCountry(detectedCountry);

   // Cache the detected location
   setCachedLocation(lat, lng, cityName, detectedCountry);
  }

  // Try to use cached prayer times
  var cachedPrayers = !forceRefresh ? getCachedPrayerTimes() : null;

  if (cachedPrayers) {
   ramadanData = cachedPrayers.ramadanData;
   todayTimings = cachedPrayers.todayTimings;
  } else {
   loadingEl.textContent = "Fetching prayer times...";

   var prayerTimes = await fetchPrayerTimes(lat, lng, activeMethod);

   if (prayerTimes.length === 0) throw new Error("No prayer times returned");

   ramadanData = prayerTimes;
   // Cache the fetched prayer times
   setCachedPrayerTimes(ramadanData, todayTimings);
  }

  document.getElementById("heading").textContent = "\uD83C\uDF19 Ramadan 2026 - " + cityName;
  document.getElementById("locationName").textContent = "\uD83D\uDCCD " + cityName;
  document.title = "Ramadan 2026 - " + cityName;

 } catch (err) {
  console.log("Using fallback data:", err.message || err);
  detectedCountry = "GB";
  activeMethod = 15;
  lat = 51.6255;
  lng = 0.0755;
  document.getElementById("heading").textContent = "\uD83C\uDF19 Ramadan 2026 - Chigwell";
  document.getElementById("locationName").textContent = "\uD83D\uDCCD Chigwell (default)";
  document.title = "Ramadan 2026 - Chigwell";
  ramadanData = fallbackData;
  todayTimings = fallbackTimings;
 }

 loadingEl.style.display = "none";
 document.getElementById("locationControls").style.display = "";
 buildTable();
 renderNamazTimes();
 updateDisplay();
 setInterval(updateDisplay, 1000);
}

function buildTable() {
 var tbody = document.querySelector("#timetableTable tbody");
 var today = new Date().toISOString().split("T")[0];
 tbody.innerHTML = "";

 var todayIndex = -1;
 ramadanData.forEach(function(row, idx) {
  var tr = document.createElement("tr");
  if (row.date === today) {
   tr.classList.add("highlight");
   todayIndex = idx;
  }
  tr.innerHTML = "<td>" + row.day + "</td>" +
   "<td>" + row.sehri + "</td>" +
   "<td>" + row.aftar + "</td>";
  tbody.appendChild(tr);
 });

 document.getElementById("timetablePanel").style.display = "";

 // Scroll to today's row if it exists
 if (todayIndex >= 0) {
  var scrollEl = document.getElementById("timetableScroll");
  setTimeout(function() {
   var rows = tbody.querySelectorAll("tr");
   if (rows[todayIndex]) {
    var rowTop = rows[todayIndex].offsetTop - scrollEl.offsetTop;
    scrollEl.scrollTop = Math.max(0, rowTop - 40);
   }
  }, 100);
 }

 // Hide scroll hint if all rows fit
 var scrollEl = document.getElementById("timetableScroll");
 var hintEl = document.getElementById("scrollHint");
 setTimeout(function() {
  if (scrollEl.scrollHeight <= scrollEl.clientHeight) {
   hintEl.style.display = "none";
  }
 }, 150);
}

function parseTime(dateStr, timeStr) {
 const [h, m] = timeStr.split(":").map(Number);
 const d = new Date(dateStr + "T00:00:00");
 d.setHours(h, m, 0, 0);
 return d;
}

function getDataForDate(dateStr) {
 return ramadanData.find(r => r.date === dateStr);
}

function getNextDateStr(dateStr) {
 const d = new Date(dateStr + "T12:00:00");
 d.setDate(d.getDate() + 1);
 return d.toISOString().split("T")[0];
}

function formatCountdown(ms) {
 if (ms <= 0) return "00:00:00";
 const totalSec = Math.floor(ms / 1000);
 const h = Math.floor(totalSec / 3600);
 const m = Math.floor((totalSec % 3600) / 60);
 const s = totalSec % 60;
 return String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}

function renderTimeBoxes(topLabel, topTime, topCountdown, bottomLabel, bottomTime) {
 const container = document.getElementById("timeBoxes");
 container.innerHTML = `
  <div class="time-box next-event">
   <h3>${topLabel}</h3>
   <div class="time">${topTime}</div>
   <div class="countdown">‚è≥ ${topCountdown}</div>
  </div>
  <div class="time-box">
   <h3>${bottomLabel}</h3>
   <div class="time">${bottomTime}</div>
  </div>`;
}

function updateDisplay() {
 const now = new Date();
 const todayStr = now.toISOString().split("T")[0];
 const todayData = getDataForDate(todayStr);
 const tomorrowStr = getNextDateStr(todayStr);
 const tomorrowData = getDataForDate(tomorrowStr);

 document.getElementById("currentDate").innerText = now.toDateString();

 // Show Ramadan day number
 const ramadanDayEl = document.getElementById("ramadanDay");
 if (todayData && todayData.day) {
  ramadanDayEl.innerText = "Ramzan Day " + todayData.day + " of 30";
 } else {
  const upcoming = ramadanData.find(r => r.date >= todayStr);
  if (upcoming) {
   const startDate = new Date(ramadanData[0].date + "T00:00:00");
   const diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
   ramadanDayEl.innerText = "Ramzan starts in " + diffDays + " day" + (diffDays !== 1 ? "s" : "");
  } else {
   ramadanDayEl.innerText = "";
  }
 }

 if (todayData) {
  const sehriTime = parseTime(todayStr, todayData.sehri);
  const aftarTime = parseTime(todayStr, todayData.aftar);

  if (now < sehriTime) {
   // Before Sehri: Sehri on top with countdown, Aftar below
   const diff = sehriTime - now;
   renderTimeBoxes(
    "Sehri Ends In", todayData.sehri, formatCountdown(diff),
    "Today's Aftar", todayData.aftar
   );
  } else if (now < aftarTime) {
   // After Sehri, before Aftar: Aftar on top with countdown, next Sehri below
   const diff = aftarTime - now;
   const nextSehriLabel = tomorrowData ? "Tomorrow's Sehri" : "Today's Sehri";
   const nextSehriTime = tomorrowData ? tomorrowData.sehri : todayData.sehri;
   renderTimeBoxes(
    "Aftar In", todayData.aftar, formatCountdown(diff),
    nextSehriLabel, nextSehriTime
   );
  } else {
   // After Aftar: next Sehri on top with countdown, next Aftar below
   if (tomorrowData) {
    const nextSehri = parseTime(tomorrowStr, tomorrowData.sehri);
    const diff = nextSehri - now;
    renderTimeBoxes(
     "Next Sehri In", tomorrowData.sehri, formatCountdown(diff),
     "Tomorrow's Aftar", tomorrowData.aftar
    );
   } else {
    // Last day of Ramadan, after Aftar - no more data
    renderTimeBoxes(
     "Ramadan Complete", "üéâ", "Eid Mubarak!",
     "May Allah accept", "your fasts"
    );
   }
  }
 } else {
  // Not a Ramadan day - find the nearest upcoming data
  const upcoming = ramadanData.find(r => r.date >= todayStr);
  if (upcoming) {
   const nextSehri = parseTime(upcoming.date, upcoming.sehri);
   const diff = nextSehri - now;
   renderTimeBoxes(
    "Next Sehri (Day " + upcoming.day + ")", upcoming.sehri, formatCountdown(diff),
    "Next Aftar (Day " + upcoming.day + ")", upcoming.aftar
   );
  } else {
   // Ramadan is over
   renderTimeBoxes(
    "Ramadan 2026", "Complete", "Eid Mubarak! üéâ",
    "May Allah accept", "your fasts"
   );
  }
 }
}

function toggleManualEntry() {
 var form = document.getElementById("manualLocationForm");
 var isVisible = getComputedStyle(form).display !== "none";
 form.style.display = isVisible ? "none" : "block";
 if (!isVisible) {
  document.getElementById("cityInput").focus();
  document.getElementById("locationResults").innerHTML = "";
  document.getElementById("locationError").style.display = "none";
 }
}

async function searchCity() {
 var query = document.getElementById("cityInput").value.trim();
 var errorEl = document.getElementById("locationError");
 var resultsEl = document.getElementById("locationResults");
 resultsEl.innerHTML = "";
 errorEl.style.display = "none";

 if (!query) {
  errorEl.textContent = "Please enter a city name.";
  errorEl.style.display = "block";
  return;
 }

 errorEl.style.display = "none";
 resultsEl.innerHTML = "<li style='cursor:default;color:#94a3b8;'>Searching...</li>";

 try {
  var resp = await fetch("https://nominatim.openstreetmap.org/search?q=" + encodeURIComponent(query) + "&format=json&limit=5&addressdetails=1");
  if (!resp.ok) throw new Error("API returned " + resp.status);
  var data = await resp.json();

  resultsEl.innerHTML = "";

  if (!data || data.length === 0) {
   errorEl.textContent = "No results found. Try a different search term.";
   errorEl.style.display = "block";
   return;
  }

  data.forEach(function(place) {
   var li = document.createElement("li");
   li.textContent = place.display_name;
   li.onclick = function() { selectManualLocation(place); };
   resultsEl.appendChild(li);
  });
 } catch (e) {
  resultsEl.innerHTML = "";
  errorEl.textContent = "Search failed. Please check your internet connection.";
  errorEl.style.display = "block";
 }
}

async function selectManualLocation(place) {
 var lat = parseFloat(place.lat);
 var lng = parseFloat(place.lon);
 var addr = place.address || {};
 var city = addr.city || addr.town || addr.village || addr.suburb || addr.county || place.display_name.split(",")[0];
 var countryCode = (addr.country_code || "").toUpperCase();

 // Hide the manual form
 document.getElementById("manualLocationForm").style.display = "none";
 document.getElementById("cityInput").value = "";
 document.getElementById("locationResults").innerHTML = "";

 // Clear existing caches and show loading
 clearCache();
 document.getElementById("loading").style.display = "";
 document.getElementById("loading").textContent = "Loading prayer times for " + city + "...";

 // Cache the manually selected location
 setCachedLocation(lat, lng, city, countryCode);
 detectedCountry = countryCode;
 activeMethod = getMethodForCountry(detectedCountry);

 // Fetch new prayer times
 try {
  var prayerTimes = await fetchPrayerTimes(lat, lng, activeMethod);
  if (prayerTimes.length === 0) throw new Error("No prayer times returned");
  ramadanData = prayerTimes;
  setCachedPrayerTimes(ramadanData, todayTimings);
 } catch (e) {
  console.log("Error fetching prayer times for manual location:", e.message || e);
 }

 document.getElementById("heading").textContent = "\uD83C\uDF19 Ramadan 2026 - " + city;
 document.getElementById("locationName").textContent = "\uD83D\uDCCD " + city;
 document.title = "Ramadan 2026 - " + city;
 document.getElementById("loading").style.display = "none";

 buildTable();
 renderNamazTimes();
 updateDisplay();
}
document.getElementById("cityInput").addEventListener("keydown", function(e) {
 if (e.key === "Enter") { e.preventDefault(); searchCity(); }
});

initApp();
</script>

</body>
</html>